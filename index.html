<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FlexiForm App</title>
<link rel="manifest" href="manifest.json">
<style>
  body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(135deg,#0066ff,#00ccff);min-height:100vh;display:flex;align-items:center;justify-content:center}
  .container{width:95%;max-width:420px;background:#fff;border-radius:16px;padding:20px;box-shadow:0 12px 30px rgba(0,0,0,.18)}
  h2{text-align:center;color:#0066ff;margin:8px 0}
  input,select,button,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin:8px 0;box-sizing:border-box}
  button{background:#0066ff;color:#fff;border:0;cursor:pointer}
  .hidden{display:none}
  .link{color:#0066ff;text-align:center;display:block;cursor:pointer;margin-top:8px}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .status{font-size:13px}
</style>
<script>
// *********************** CONFIG ***********************
// Use a proxy to fix CORS errors from GitHub Pages
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwH-oS1f4HWAAZD2MA-zLjkvXamhqset5e7l_FAgAark5wkhkng2CKmvWwZPlnYndCO/exec";

// Register service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js')
    .then(()=>console.log('ServiceWorker registered'))
    .catch(err=>console.log('SW failed',err));
}

// ---------------- Helper to POST JSON ----------------
async function postJSON(payload) {
  try {
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    // If proxy or backend responds OK
    if (!res.ok) throw new Error("HTTP status " + res.status);
    const text = await res.text();

    // Apps Script sometimes returns text/html, so parse safely
    try {
      return JSON.parse(text);
    } catch {
      console.warn("Non-JSON response:", text);
      return { status:"error", message:"Invalid response from server" };
    }

  } catch (err) {
    console.error("Network error:", err);
    return { status:"error", message:"Network error: " + err.message };
  }
}

function show(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}
function backToStart(){ show('startPage'); }

// ---------------- LOGIN ----------------
async function login(){
  const u = document.getElementById('loginUsername').value.trim();
  const p = document.getElementById('loginPassword').value.trim();
  const msg = document.getElementById('loginMsg');
  msg.style.color="#555"; msg.textContent="Checking...";
  const res = await postJSON({ action:"loginUser", username:u, password:p });
  if (!res) { msg.style.color="red"; msg.textContent="Network error"; return; }

  if (res.status === "admin") {
    msg.style.color="green"; msg.textContent=res.message;
    show('adminDashboard'); loadProjects(true);
  } else if (res.status === "user") {
    msg.style.color="green"; msg.textContent=res.message;
    sessionStorage.setItem('userName', res.name||u);
    sessionStorage.setItem('userUsername', u);
    show('userDashboard'); loadProjects(false);
  } else {
    msg.style.color="red"; msg.textContent=res.message;
  }
}

// ---------------- REGISTER ----------------
async function register(){
  const payload = {
    action:"registerUser",
    firstName:document.getElementById('firstName').value.trim(),
    lastName:document.getElementById('lastName').value.trim(),
    department:document.getElementById('department').value.trim(),
    contact:document.getElementById('contact').value.trim(),
    email:document.getElementById('email').value.trim(),
    username:document.getElementById('username').value.trim(),
    password:document.getElementById('password').value.trim(),
    refcode:document.getElementById('refcode').value.trim()
  };
  const msg=document.getElementById('registerMsg');
  msg.style.color="#555"; msg.textContent="Submitting...";
  const res=await postJSON(payload);
  msg.style.color=(res.status==="success")?"green":"red";
  msg.textContent=res.message||"Network error";
  if(res.status==="success"){setTimeout(()=>show('startPage'),1200);}
}

// ---------------- Projects (Admin) ----------------
async function createProjectUI(){
  const name=document.getElementById('projName').value.trim();
  const descr=document.getElementById('projDesc').value.trim();
  if(!name){alert("Project name required");return;}
  const res=await postJSON({action:"createProject",adminKey:"ADMINBOYKA",projectName:name,description:descr,creator:"ADMIN"});
  alert(res.message||"Network error");
  if(res.status==="success"){
    document.getElementById('projName').value="";
    document.getElementById('projDesc').value="";
    loadProjects(true);
  }
}

async function loadProjects(isAdmin){
  const res=await postJSON({action:"listProjects"});
  const listEl=document.getElementById(isAdmin?'adminProjectsList':'userProjectsList');
  if(!res||res.status!=="success"){listEl.innerHTML="<p>No projects found</p>";return;}
  const projects=res.projects||[];
  if(!projects.length){listEl.innerHTML="<p>No projects found</p>";return;}

  listEl.innerHTML="";
  projects.forEach(p=>{
    const div=document.createElement('div');
    div.style.border="1px solid #eee";div.style.padding="10px";div.style.marginBottom="8px";div.style.borderRadius="8px";
    const t=document.createElement('div');t.textContent=p.projectName;t.style.fontWeight="600";
    const d=document.createElement('div');d.textContent=p.description||"";d.style.fontSize="13px";
    const btn=document.createElement('button');btn.textContent=isAdmin?"View / Edit":"Open Survey";
    btn.style.marginTop="8px";btn.onclick=()=>openProject(p,isAdmin);
    div.append(t,d,btn);listEl.appendChild(div);
  });
}

function openProject(project,isAdmin){
  if(isAdmin){
    const see=confirm("Do you want to see details? Press Cancel to edit.");
    if(see){
      alert("Project: "+project.projectName+"\nCreated: "+new Date(project.dateCreated).toLocaleString());
    }else{
      document.getElementById('projName').value=project.projectName;
      document.getElementById('projDesc').value=project.description;
      show('adminCreateProject');
    }
  }else{
    document.getElementById('surveyProjectName').textContent=project.projectName;
    document.getElementById('surveyProjectDesc').textContent=project.description;
    document.getElementById('survey_projectName_input').value=project.projectName;
    show('userSurvey');
  }
}

// ---------------- Submit survey (User) ----------------
async function submitSurvey(){
  const projectName=document.getElementById('survey_projectName_input').value;
  const username=sessionStorage.getItem('userUsername');
  const email=sessionStorage.getItem('userEmail')||"none";
  const answer1=document.getElementById('q1').value.trim();
  const res=await postJSON({action:"submitSurvey",projectName,username,email,answers:{q1:answer1}});
  alert(res.message||"Network error");
  if(res.status==="success"){show('userDashboard');loadProjects(false);}
}

document.addEventListener('DOMContentLoaded',()=>show('startPage'));
</script>
</head>
<body>
  <div class="container">

    <!-- Start Page -->
    <div id="startPage" class="page">
      <h2>Do you have an account?</h2>
      <button onclick="show('loginPage')">Yes, Login</button>
      <button onclick="show('registerPage')">No, Register</button>
    </div>

    <!-- Login -->
    <div id="loginPage" class="page hidden">
      <h2>Login</h2>
      <input id="loginUsername" placeholder="Username">
      <input id="loginPassword" placeholder="Password" type="password">
      <button onclick="login()">Login</button>
      <span class="link" onclick="backToStart()">← Back</span>
      <p id="loginMsg"></p>
    </div>

    <!-- Register -->
    <div id="registerPage" class="page hidden">
      <h2>Register</h2>
      <input id="firstName" placeholder="First Name">
      <input id="lastName" placeholder="Last Name">
      <input id="department" placeholder="Department">
      <input id="contact" placeholder="Contact Number">
      <input id="email" placeholder="Google Email">
      <input id="username" placeholder="Username">
      <input id="password" placeholder="Password" type="password">
      <input id="refcode" placeholder="Reference Code (ask company)">
      <button onclick="register()">Register</button>
      <span class="link" onclick="backToStart()">← Back</span>
      <p id="registerMsg"></p>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="page hidden">
      <div class="topbar"><div><strong>Admin Dashboard</strong></div><div class="status">Admin</div></div>
      <div id="adminCreateProject">
        <h2>Create Project</h2>
        <input id="projName" placeholder="Project name">
        <textarea id="projDesc" placeholder="Short description" rows="3"></textarea>
        <button onclick="createProjectUI()">Create Project</button>
      </div>
      <h2 style="margin-top:12px">Projects</h2>
      <div id="adminProjectsList" style="max-height:260px;overflow:auto"></div>
    </div>

    <!-- User Dashboard -->
    <div id="userDashboard" class="page hidden">
      <div class="topbar"><div><strong>User Dashboard</strong></div><div class="status" id="userStatus">User</div></div>
      <h2>List of Projects</h2>
      <div id="userProjectsList" style="max-height:260px;overflow:auto"></div>
    </div>

    <!-- User Survey -->
    <div id="userSurvey" class="page hidden">
      <h2 id="surveyProjectName"></h2>
      <div id="surveyProjectDesc" style="font-size:13px;color:#666"></div>
      <input id="survey_projectName_input" type="hidden">
      <p style="margin-top:12px">1) Sample Question: How satisfied are you?</p>
      <input id="q1" placeholder="Your answer (short)">
      <button onclick="submitSurvey()">Submit Response</button>
      <span class="link" onclick="show('userDashboard')">← Back</span>
    </div>

  </div>
</body>
</html>




